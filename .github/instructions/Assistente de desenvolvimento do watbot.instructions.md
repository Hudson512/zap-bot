# ZapNode - AI Agent Instructions

## Architecture Overview

ZapNode is a **modular WhatsApp bot** built with Node.js using a **layered architecture**. The codebase follows SOLID principles with clear separation of concerns across 6 layers:

```
config/ ‚Üí utils/ ‚Üí services/ ‚Üí handlers/ ‚Üí commands/ ‚Üí routes/
```

Key architectural decisions:
- **Singleton pattern** for services (`whatsappService`, `commandRegistry`, `logger`)
- **Registry pattern** for extensible command system
- **Lazy loading** to avoid circular dependencies (see `help.command.js`)
- **Message filtering** by chat type (`@c.us`, `@g.us`, `@broadcast`, `@newsletter`)

## Critical Workflows

### Development Commands
```bash
npm start              # Production mode
npm run dev            # Development with trace warnings
taskkill /F /IM node.exe /T 2>$null  # Kill Node.js on Windows
```

### Session Management
- Sessions stored in `.wwebjs_auth/` (auto-generated by LocalAuth)
- Clear session: `Remove-Item -Recurse -Force .wwebjs_auth`
- Chrome runs in **non-headless mode** by default (config: `headless: false`)

### Testing Commands
```bash
# Health check
curl http://localhost:3000/health

# Test message send
curl -X POST http://localhost:3000/webhook/test \
  -H "Content-Type: application/json" \
  -d '{"phoneNumber":"244929782402","message":"Test"}'
```

## Project-Specific Conventions

### 1. Command System Pattern
**ALL commands must follow this exact structure:**
```javascript
module.exports = {
  name: "commandname",              // Used as !commandname
  description: "What it does",      // For help text
  usage: "!commandname [args]",     // Display format
  
  async execute(message, args) {
    try {
      await message.reply("Response");
      logger.success("Command executed");
      return true;
    } catch (error) {
      logger.error("Error:", error.message);
      return false;
    }
  }
};
```

**Registration in `commands/index.js`:**
```javascript
loadCommands() {
  const myCommand = require("./mycommand.command");
  this.register(myCommand);  // Adds to Map
}
```

### 2. Avoiding Circular Dependencies
**Critical pattern from `help.command.js`:**
```javascript
// ‚ùå NEVER import at module level if it creates a cycle
const commandRegistry = require("../commands");

// ‚úÖ ALWAYS import inside execute() function
async execute(message, args) {
  const commandRegistry = require("../commands");
  const commands = commandRegistry.getAll();
}
```

**Why:** `commands/index.js` loads all commands ‚Üí if a command imports the registry at module level ‚Üí circular dependency crash.

### 3. Message Filtering Logic
Messages are filtered by `helpers.shouldIgnoreMessage()`:
- **Process:** `@c.us` (private chats only)
- **Ignore:** `@g.us` (groups), `status@broadcast`, `@newsletter`

Config flags in `config/index.js`:
```javascript
features: {
  ignoreGroups: true,      // Skip group messages
  ignoreStatus: true,      // Skip WhatsApp status
  ignoreNewsletters: true  // Skip newsletter messages
}
```

### 4. Logger Usage Pattern
Use specific log levels from `utils/logger.js`:
```javascript
logger.info("General info");      // ‚ÑπÔ∏è [INFO]
logger.success("Success msg");    // ‚úÖ [SUCCESS]
logger.error("Error msg");        // ‚ùå [ERROR]
logger.warn("Warning msg");       // ‚ö†Ô∏è [WARN]
logger.debug("Debug details");    // üêõ [DEBUG]
logger.message(from, body);       // üì© [MESSAGE] (special format)
```

### 5. Phone Number Formatting
**Always use** `helpers.formatPhoneNumber()`:
```javascript
// Input: "244929782402" or "+244 929 782 402"
// Output: "244929782402@c.us"
const chatId = helpers.formatPhoneNumber(phoneNumber);
```

## Integration Points

### WhatsApp Web.js Configuration
Located in `services/whatsapp.service.js`:
```javascript
{
  authStrategy: new LocalAuth({ clientId: "zapnode-session" }),
  puppeteer: {
    executablePath: "C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe",
    headless: false,  // Visual debugging
  },
  webVersionCache: {
    type: "remote",
    remotePath: "https://raw.githubusercontent.com/wppconnect-team/wa-version/main/html/2.2412.54.html"
  }
}
```

**webVersionCache is critical** - prevents "WhatsApp Web version mismatch" errors.

### Event Flow
```
User sends message
  ‚Üí WhatsApp Web
  ‚Üí whatsapp.service.js (event: "message")
  ‚Üí message.handler.js (filters by chat type)
  ‚Üí shouldIgnoreMessage() check
  ‚Üí isCommand() check
    ‚îú‚îÄ YES ‚Üí commandRegistry.get(command).execute()
    ‚îî‚îÄ NO  ‚Üí handleRegularMessage() (no-op by default)
```

### Webhook Integration
**External systems** (Chatwoot, n8n, Make) send messages via:
```
POST /webhook
{
  "message_type": "outgoing",
  "private": false,
  "conversation": {
    "meta": {
      "sender": { "phone_number": "244929782402" }
    }
  },
  "content": "Message text"
}
```

Validation in `webhook.js`:
- Must be `message_type: "outgoing"`
- Must be `private: false`
- Checks `whatsappService.isClientReady()` before sending

## Common Pitfalls

1. **Don't edit files while server is running** - Windows locks files, causing permission errors
2. **Always kill Chrome processes** - Orphaned Chrome instances prevent reconnection
3. **Session corruption** - If QR code won't scan, delete `.wwebjs_auth/` and restart
4. **Circular dependencies** - Use lazy loading pattern (import inside functions)
5. **Message filtering** - Default config ignores groups; set `IGNORE_GROUPS=false` in `.env` to receive them

## File Reference

**Key files for understanding architecture:**
- `app/server.js` - Entry point, mounts webhook
- `app/services/whatsapp.service.js` - WhatsApp client lifecycle
- `app/handlers/message.handler.js` - Message routing and filtering logic
- `app/commands/index.js` - Command registry (singleton Map)
- `app/config/index.js` - All environment variables and feature flags
- `app/utils/helpers.js` - Chat type detection functions

**Documentation:**
- `ARCHITECTURE.md` - Detailed layer explanations and design patterns
- `PROJECT_STRUCTURE.md` - File tree and quick reference
- `README.md` - User guide and API endpoints

## Adding New Features

### New Command (3 steps)
1. Create `app/commands/newcmd.command.js` with `{ name, description, usage, execute }`
2. Register in `app/commands/index.js` ‚Üí `loadCommands()` ‚Üí `this.register(newcmd)`
3. Test with `!newcmd` in WhatsApp

### New Service
1. Create `app/services/myservice.service.js`
2. Export singleton: `module.exports = new MyService()`
3. Import in handlers/commands as needed

### New Handler
1. Create `app/handlers/myhandler.handler.js`
2. Connect to `whatsappService` event listeners in `setupEventListeners()`

## Environment Variables

Required in `.env`:
```env
# Server
PORT=3000
NODE_ENV=development

# WhatsApp
SESSION_NAME=zapnode-session
CHROME_PATH=C:\Program Files\Google\Chrome\Application\chrome.exe
HEADLESS=false
TEST_NUMBER=244929782402

# Features
WEBHOOK_ENABLED=true
IGNORE_GROUPS=true
IGNORE_STATUS=true
IGNORE_NEWSLETTERS=true
```

See `.env.example` for full template.
